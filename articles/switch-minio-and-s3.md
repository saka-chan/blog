# MinIOとS3をローカルで切り替える｜積み木開発テンプレート改善事例

こんにちは。株式会社Digeonでエンジニアをしている坂下です。

Digeonでは「積み木開発」という独自の開発手法を採用しています。これは、再利用可能な部品（コンポーネント）を積み木のように組み合わせていくことで、効率的かつ高品質なソフトウェアを開発するアプローチです。

![積み木開発のイメージ画像](../images/tsumiki-development.png)
> ※参考：[積み木開発とは](https://note.com/digeon/n/ne4c6d6f00b29)

弊社では新しいプロジェクトを始める際、あらかじめ用意された「積み木開発テンプレートリポジトリ」をフォークしてスタートします。  
テンプレートは、次のプロジェクトでよりスムーズに開発を始められるよう常にアップデートを重ねています。

今回はその改善の一環として、**ローカル環境でMinIOとAmazon S3を自由に切り替えて利用できる機能**を追加しました。  
この記事では、その背景と仕組み、そして導入後の効果について紹介します。

---

## 取り組みの背景

積み木開発のテンプレートには、ファイルアップロードなどの共通機能が含まれています。  
これまではローカル環境でもAWS S3バケットを直接利用していましたが、以下のような課題がありました。

- テスト用にS3バケットとIAMキーを都度発行する必要があり、手間である
- セキュリティ上、AWSキー発行権限を持つメンバーが限られている
- 「開発中はローカルで動かせないので、とりあえず後でやる」が発生しやすい

これらは数分の手間に見えても、開発者体験の継続的な摩擦として積み重なります。  
今回の改善は、この摩擦を減らし、開発を即スタートできる環境を整備することを目的に行いました。

---

## 改善方針：MinIOでS3互換ストレージをローカルに立てる

AWS S3と互換性のあるオープンソースストレージ「[MinIO](https://www.min.io/)」を利用し、ローカルでも同一APIでファイルアップロード機能を動かせるようにしました。

### 環境変数でストレージ設定を切替可能にする
アプリケーション側では、環境変数によって利用するストレージを切り替えます。

```bash
# true: MinIO / false: AWS S3
IS_ON_PREMISE_STORAGE=true 

# 共通のS3互換設定
AWS_ACCESS_KEY_ID=your_access_key
AWS_SECRET_ACCESS_KEY=your_secret_key
AWS_REGION=ap-northeast-1
S3_BUCKET=sample

# MinIO用設定
MINIO_ENDPOINT=http://minio:9000
MINIO_PRESIGN_ENDPOINT=http://localhost:9000
```

アプリケーションはこのフラグを参照して、S3クライアントまたはMinIOクライアントを自動的に選択します。  
ローカルからS3へ接続したい場合は、アクセスキー等を設定した上でフラグを切り替えればOKです。プロダクション環境でも同じコードがS3へ接続するため、環境ごとの差異を気にせず開発できるようになっています。

### docker-composeでMinIOを自動起動する

開発用の`docker-compose.yml`に、MinIOのサービスを定義しています。  

```yaml
minio:
  image: minio/minio:RELEASE.2024-07-29T22-14-52Z
  ports:
    - "9000:9000"        # S3 API
    - "9001:9001"        # Console
  environment: # 仮
    - MINIO_ROOT_USER=root
    - MINIO_ROOT_PASSWORD=password
  command: server /data --address :9000 --console-address :9001
  volumes:
    - ./minio/data:/data

mc:
  image: minio/mc:RELEASE.2023-12-23T08-47-21Z
  depends_on:
    - minio
  entrypoint: >
    /bin/sh -c "
    mc alias set myminio http://minio:9000 root password;
    mc mb myminio/sample;
    "
```

MinIO Client（`mc`）が初回起動時に`sample`バケットを自動作成します。  
`docker compose up`を実行するだけでMinIOが自動起動し、ローカルで即座に利用可能になります。  
ブラウザから `http://localhost:9001` にアクセスすれば、Webコンソールでオブジェクトの状態確認も可能です。

---

## モック削減で自動テストの信頼性を高める

（こちらは約1年前に導入しましたが、振り返りとしてご紹介します）

これまで、署名付きURL発行などS3アクセスに関わる部分はMock化してテストしていました。  
しかし、Mockテストでは「処理が呼ばれたか」しか確認できず、本番環境との乖離リスクがありました。

この課題を解消するため、該当部分をMinIOに差し替え、より本番環境に近い形でのテストができるようにしました。

MinIO導入による改善点：
- 実際にオブジェクトPUT/GETを行う統合テストが可能
- 署名付きURL発行の検証が本番相当で実施できる
- Mockコードを削減し、テスト信頼性を向上

MinIOを導入したテストによって、「通ってはいるが安全ではないテスト」から、「本番同等の信頼を持てるテスト」になりました。  
見かけ上の安心感ではなく、コードベースの実質的な信頼性向上につながったことは大きな成果だと感じています。

---

## 開発効率とストレス軽減、小さな改善を積み重ねる

今回の取り組み自体は、開発体験を劇的に変えるようなものではありません。  
それでも、毎回S3環境を準備する手間がなくなり、ローカル開発や自動テストの基盤を整備できたことで、開発の快適さが確実に向上しました。

- 新規開発時にすぐファイル機能を実装・テストできる
- AWSアクセス権限のやり取りが不要に
- テスト基盤の信頼性向上
- テンプレート更新が他プロジェクトにも波及

これらが**開発者×プロジェクト数分**積み上がり、長期的に見れば大きな価値を生み出す改善になったと考えています。

---

## まとめ：より効率的で、スピーディーな開発へ
MinIOを導入してローカル開発でS3を再現できるようにすることで、開発体験・テスト信頼性・生産性を改善できました。

Digeonでは、小さな改善にレバレッジを効かせ、チーム全体の生産性を押し上げていく文化を大切にしています。  
今後も「高品質なソフトウェアを爆速で提供する」ために、テンプレートの改善や積み木開発の推進を続けていきます。  

こうした改善や取り組みに興味がある方、一緒に開発を進化させていきませんか？  
まずはカジュアル面談から、ぜひお話ししましょう。  
採用情報: https://digeon.co/jobs

---
